# Primary host; required: SUPABASE_DOMAIN (e.g. example.com or api.example.com)
{$SUPABASE_DOMAIN} {
	tls {env.SUPABASE_TLS_EMAIL}


	encode zstd gzip
	header {
		Referrer-Policy "no-referrer-when-downgrade"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "0"
	}

	# Long-cache static assets (no path rewrite)
	@next path /_next/*
	header @next Cache-Control "public, max-age=31536000, immutable"
	@nextstatic path /_next/static/*
	header @nextstatic Cache-Control "public, max-age=31536000, immutable"
	@monaco path /monaco-editor/*
	header @monaco Cache-Control "public, max-age=31536000, immutable"
	@img path /img/*
	header @img Cache-Control "public, max-age=31536000, immutable"
	@media path /media/* /_next/static/media/*
	header @media Cache-Control "public, max-age=31536000, immutable"
	@editor path /editor/*
	header @editor Cache-Control "public, max-age=31536000, immutable"

	reverse_proxy kong:8000 {
		flush_interval -1
		transport http {
			versions 1.1
			read_timeout 600s
			write_timeout 600s
			dial_timeout 10s
			keepalive 30s
		}
	}
}

# HTTP â†’ HTTPS redirect for bare HTTP
:80 {
	redir https://{host}{uri} permanent
}
