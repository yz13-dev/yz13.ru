# Primary host; required: SUPABASE_DOMAIN (e.g. example.com or api.example.com)
{$SUPABASE_DOMAIN} {

	encode zstd gzip
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		Referrer-Policy "no-referrer-when-downgrade"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "0"
	}

	# Long-cache static assets
	handle_path /_next/* {
		header Cache-Control "public, max-age=31536000, immutable"
		reverse_proxy kong:8000
	}
	handle_path /monaco-editor/* {
		header Cache-Control "public, max-age=31536000, immutable"
		reverse_proxy kong:8000
	}
	handle_path /_next/static/* {
		header Cache-Control "public, max-age=31536000, immutable"
		reverse_proxy kong:8000
	}
	handle_path /img/* {
		header Cache-Control "public, max-age=31536000, immutable"
		reverse_proxy kong:8000
	}

	reverse_proxy kong:8000 {
		flush_interval -1
		transport http {
			versions 1.1
			read_timeout 600s
			write_timeout 600s
			dial_timeout 10s
			keepalive 30s
		}
	}
}

# HTTP â†’ HTTPS redirect for bare HTTP
:80 {
	redir https://{host}{uri} permanent
}

